<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectra Fitting Application</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .jumbotron {
            background-color: #f2f2f2;
            border-radius: 0.5rem;
            padding: 2rem;
            margin-top: 2rem;
        }
        .btn-custom {
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1.5rem;
            margin: 0.5rem;
            border: none;
            border-radius: 0.3rem;
            cursor: pointer;
        }
        .btn-custom:hover {
            background-color: #45a049;
        }
        .container {
            padding-top: 2rem;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("specnameChoiceForm").addEventListener("submit", function(event) {
                event.preventDefault(); // Prevents the default form submission action
                plot_fitted_result_one_star();
            });
        });
    </script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">TSGuiPy</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/config">Config Creator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/monitor">Job Monitor</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/plot_results">Results Viewer</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="#">Analyse results</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/generate_synthetic_spectrum">Generate synthetic spectrum</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Jumbotron -->
    <div class="container">
        <div class="jumbotron">
            <h1 class="display-4">Analyse results!</h1>
            <p class="lead">Choose folder with the results. If too many files (>1000?) please zip the results folder and upload it instead</p>
            <hr class="my-4">
            <p>Change.</p>
            <div class="form-group">
                <input type="checkbox" class="form-check-input" id="overplotBlendsCheck" name="overplotBlendsCheck">
                <label class="form-check-label" for="overplotBlendsCheck">Overplot blends</label>
            </div>

            <form id="specnameChoiceForm" method="post">
                <select id="specname">
                    {% for option in options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
                <input class="btn btn-info" type="submit" value="Generate results">
            </form>
                <div id="plotsGrid"></div>
                <div id="meanValue">Mean Value: </div>
                <div id="standardError">Standard error: </div>
                <div id="countValue">Lines: </div>

            <div id="plot-container"></div>
        </div>

    </div>

    <script>
    function plot_fitted_result_one_star() {
        const requestData = {
            specname: document.getElementById("specname").value,
            overplotBlendsCheck: document.getElementById("overplotBlendsCheck").checked
        };
        // Send AJAX request to Flask to generate plots
        $.ajax({
            url: '/plot_fitted_result_one_star',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                displayFigures(response.figures);
            }
        });
    };

    function displayFigures(figures) {
        const plotsGrid = document.getElementById('plotsGrid');
        plotsGrid.innerHTML = ''; // Clear existing content
        figures.forEach((figData, index) => {
            const plotContainer = document.createElement('div');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'checkbox' + index;
            checkbox.setAttribute('data-value', figData.value);
            checkbox.checked = true; // Set the checkbox to be checked initially
            checkbox.addEventListener('change', () => updateMeanValue(figures));

            Plotly.newPlot(plotContainer, JSON.parse(figData.figure));
            plotsGrid.appendChild(plotContainer);
            plotsGrid.appendChild(checkbox);
        });

        updateMeanValue(figures); // Call updateMeanValue initially to display the mean value
    }


    function updateMeanValue(figures) {
        let sum = 0;
        let count = 0;
        let values = [];
        figures.forEach((_, index) => {
            const checkbox = document.getElementById('checkbox' + index);
            if (checkbox.checked) {
                const value = parseFloat(checkbox.getAttribute('data-value'));
                values.push(value);
                sum += value;
                count++;
            }
        });

        const meanValue = count > 0 ? sum / count : 0;
        let sumOfSquares = 0;
        values.forEach(value => {
            sumOfSquares += Math.pow(value - meanValue, 2);
        });
        const stdDeviation = count > 1 ? Math.sqrt(sumOfSquares / (count - 1)) : 0;
        const standardError = count > 0 ? stdDeviation / Math.sqrt(count) : 0;

        document.getElementById('meanValue').textContent = 'Mean Value: ' + meanValue.toFixed(3);
        document.getElementById('standardError').textContent = 'Standard error: ' + standardError.toFixed(3);
        document.getElementById('countValue').textContent = 'Count: ' + count;
    }

    </script>

</body>
</html>
